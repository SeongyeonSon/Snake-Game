// Summary
// ë³¸ í”„ë¡œì íŠ¸ëŠ” í”Œë ˆì´ì–´ ê°„ ì¶©ëŒ, ë¨¹ì´ ìƒì„±/ì†Œë©¸, ì ìˆ˜íŒ, ëª¸í†µ ê¸¸ì´ ì¦ê°€, í™”ë©´ ê²½ê³„ ì œì–´ ë“±ì˜ ê¸°ëŠ¥ì„ ë‹¨ê³„ì ìœ¼ë¡œ êµ¬í˜„í•¨.
// ê¸°ëŠ¥ ê°„ ì˜ì¡´ì„±ê³¼ ì‹œê°ì  íš¨ê³¼ë¥¼ ê³ ë ¤í•´, ì¶©ëŒ ê°ì§€ë¥¼ ê°€ì¥ ë¨¼ì € êµ¬í˜„í•˜ì—¬ ê²Œì„ì˜ ê¸°ë³¸ ì¢…ë£Œ ì¡°ê±´ì„ ë§ˆë ¨í•˜ê³ ,
// ì´í›„ ë¨¹ì´ë¥¼ ë¨¹ì„ ë•Œë§ˆë‹¤ ê°œìˆ˜ë¥¼ ìœ ì§€í•˜ë„ë¡ ì„¤ì •í•´ ë°˜ë³µ ê°€ëŠ¥í•œ ê²Œì„ íë¦„ì„ êµ¬ì„±í•¨.
// ì ìˆ˜ì™€ ëª¸í†µ ê¸¸ì´ëŠ” ë¨¹ì´ ì„­ì·¨ í›„ì— ë°˜ì˜ë˜ëŠ” ì‹œê°ì /ë…¼ë¦¬ì  íš¨ê³¼ì´ë¯€ë¡œ ê·¸ ë‹¤ìŒ ìˆœì„œë¡œ êµ¬í˜„ë˜ì—ˆìœ¼ë©°,
// ë§ˆì§€ë§‰ìœ¼ë¡œ í™”ë©´ ë°–ìœ¼ë¡œ ë²—ì–´ë‚˜ëŠ” í”Œë ˆì´ë¥¼ ì œí•œí•´, ì „ì²´ ê²Œì„ ì˜ì—­ì´ ìœ ì§€ë˜ë„ë¡ ì œì–´í•¨.
// 1. [ê¸°ëŠ¥ 1] ì¶©ëŒ ì²´í¬ - ë©ˆì¶¤ìœ¼ë¡œ êµ¬í˜„
//  - ì„œë²„: ì¶©ëŒ ì—¬ë¶€ íŒë‹¨ì„ ìœ„í•œ player ê°„ ìœ„ì¹˜ ë¹„êµ
//  - í´ë¼ì´ì–¸íŠ¸: ì¶©ëŒ ë°œìƒ ì‹œ alert ì¶œë ¥ ë° clearInterval()ë¡œ ê²Œì„ ë©ˆì¶¤ ì²˜ë¦¬
// 2. [ê¸°ëŠ¥ 3] ë¨¹ì´ ì „ì²´ ê°œìˆ˜ ìœ ì§€ (ë¨¹ì´ ë¨¹ìœ¼ë©´ ìƒˆë¡œìš´ ë¨¹ì´ ìƒì„±)
//  - ì„œë²„: ë¨¹ì´ ì œê±° ë° ìƒˆ ë¨¹ì´ foods.push() ìƒì„±
//  - í´ë¼ì´ì–¸íŠ¸: ì„œë²„ì—ì„œ ì „ë‹¬ëœ ìµœì‹  foods ë°°ì—´ì„ ë°›ì•„ì„œ ë Œë”ë§
// 3. [ê¸°ëŠ¥ 4] í”Œë ˆì´ì–´ ë³¸ì¸ ì ìˆ˜íŒ(í´ë¼ì´ì–¸íŠ¸)-> íƒ€ í”Œë ˆì´ì–´ ì ìˆ˜íŒ ì¶”ê°€ (ì„œë²„ -> í´ë¼ì´ì–¸íŠ¸)
// 4. [ê¸°ëŠ¥ 2] í”Œë ˆì´ì–´ ë³¸ì¸ ëª¸í†µ ê¸¸ì´ ì¶”ê°€(í´ë¼ì´ì–¸íŠ¸) -> íƒ€ í”Œë ˆì´ì–´ ëª¸í†µ ê¸¸ì´ ì¶”ê°€ (ì„œë²„ -> í´ë¼ì´ì–¸íŠ¸)
// 5. [ê¸°ëŠ¥ 5 / ì¶”ê°€ê¸°ëŠ¥] í”Œë ˆì´ì–´ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ìœ„ì¹˜ ì œí•œ (í´ë¼ì´ì–¸íŠ¸)

// index.js
const express = require("express");
const http = require("http");
const { Server } = require("socket.io");
const path = require("path");

const app = express();
const server = http.createServer(app);
const io = new Server(server);

const PORT = 1818; // 1 ~ 1024

app.use(express.static(path.join
    (__dirname, '../client'))); 

/* ê²Œì„ ë¡œì§ ì‹œì‘ */
const players = {};
const foods = generateFoods(50);

function generateFoods(count){
    const arr = [];
    for(let i=0; i<count; i++){
        arr.push({
            id: `food_${i}`, //í‚¤ë³´ë“œ 1 ì™¼ìª½ì˜ ë”°ì˜´í‘œ
            x: Math.random() * 800, 
            y: Math.random() * 600,
        });
    }
    return arr;
}

// [ê¸°ëŠ¥ 3] í”Œë ˆì´ì–´ & ë¨¹ì´ ì¶©ëŒ ì²´í¬ í•¨ìˆ˜ ì¶”ê°€ - ë‘ ë²ˆì§¸ë¡œ êµ¬í˜„
// í”Œë ˆì´ì–´ê°„ ì¶©ëŒ í•¨ìˆ˜ì™€ ë§ˆì°¬ê°€ì§€ë¡œ ìˆ˜ë°•ê²Œì„ì—ì„œ ê³¼ì¼ ê°„ ì¶©ëŒì„ ê±°ë¦¬ë¡œ íŒë‹¨í–ˆë˜ ë°©ì‹ì—ì„œ ì°©ì•ˆ 
// ë¬¼ë¦¬ì—”ì§„ ì—†ì´ ìˆ˜í•™ì  ê±°ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ì¶©ëŒ íŒë‹¨. 
function checkFoodCollision(player, food) {
    const dx = player.x - food.x;
    const dy = player.y - food.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    return distance < 15; // í”Œë ˆì´ì–´ ë°˜ì§€ë¦„ 10 + ë¨¹ì´ ë°˜ì§€ë¦„ 5
}

// *[ê¸°ëŠ¥ 1]ë‘ í”Œë ˆì´ì–´ ê°„ ì¶©ëŒ ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” í•¨ìˆ˜ - ì²« ë²ˆì§¸ë¡œ êµ¬í˜„*
    // Matter.js ê¸°ë°˜ì˜ ìˆ˜ë°•ê²Œì„ì—ì„œëŠ” ë¬¼ë¦¬ ì—”ì§„ì´ ê° ê°ì²´ì˜ ì¶©ëŒì„ ìë™ìœ¼ë¡œ ê°ì§€í•˜ê³ ,
    // Events.on('collisionStart') ì´ë²¤íŠ¸ë¥¼ í†µí•´ ê°„í¸í•˜ê²Œ ì¶©ëŒ ì²˜ë¦¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆì—ˆìŒ.
    // ë³¸ í”„ë¡œì íŠ¸ì—ì„œë„ ì´ˆê¸°ì—ëŠ” ë™ì¼í•œ ë°©ì‹ì˜ ì½”ë“œ í™œìš©ì„ ê³ ë ¤í–ˆìœ¼ë‚˜,
    // GPTë¥¼ í†µí•´ êµ¬ì¡°ì  ì°¨ì´ë¥¼ ê²€í† í•œ ê²°ê³¼, ë³¸ í”„ë¡œì íŠ¸ëŠ” Matter.jsì™€ ê°™ì€ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³ ,
    // socket ê¸°ë°˜ìœ¼ë¡œ í”Œë ˆì´ì–´ì˜ ìœ„ì¹˜ ì¢Œí‘œë§Œì„ ì£¼ê¸°ì ìœ¼ë¡œ ìˆ˜ì‹ /ê°±ì‹ í•˜ëŠ” êµ¬ì¡°ì´ê¸° ë•Œë¬¸ì—,
    // ë¬¼ë¦¬ ì—”ì§„ì´ ì œê³µí•˜ëŠ” ìë™ ì¶©ëŒ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ.
    // ì´ì— ë”°ë¼ ëª¨ë“  í”Œë ˆì´ì–´ ìŒì„ ìˆ˜ë™ìœ¼ë¡œ ìˆœíšŒí•˜ë©°, ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•´ ì¶©ëŒ ì—¬ë¶€ë¥¼ íŒë³„í•˜ê³ 
    // ì¶©ëŒì´ ê°ì§€ëœ ê²½ìš° í•´ë‹¹ ê°ì²´ë¥¼ ì§ì ‘ ì œê±°í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë¡œì§ì„ êµ¬ì„±í•¨.
function checkPlayerCollision(p1, p2) {
    const dx = p1.x - p2.x;
    const dy = p1.y - p2.y;
    const distance = Math.sqrt(dx * dx + dy * dy);
    return distance < 20;
}

io.on('connection', (socket) => {
    console.log(`User connected : ${socket.id}`);

    // ì ‘ì†í•œ ìƒˆë¡œìš´ ìœ ì € ì •ë³´ ìƒì„±
    players[socket.id] = { 
        id: socket.id,
        x: Math.random() * 800,
        y: Math.random() * 600,
        angle: 0,
        speed: 2,
        score: 0, // [ê¸°ëŠ¥ 4] ì ìˆ˜ ì´ˆê¸°í™” ì¶”ê°€
        bodySegments: [] // [ê¸°ëŠ¥ 2-2] ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ëª¸í†µ ì¶”ê°€        
    };

    socket.on('move', ({angle}) => {
        if(players[socket.id]){     
            players[socket.id].angle = angle; // ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ìœ„í•œ ì¡°ê±´ë¬¸, ì•µê¸€ë§Œ ì—…ë°ì´íŠ¸
        }
    })

    socket.emit('init', {
        player: players[socket.id],
        foods: foods,
    });

    socket.on('disconnect', () => {
        console.log(`User disconnected: ${socket.id}`);
        delete players[socket.id];
    });
})

//ëª¨ë“  ì‚¬ìš©ìì˜ angle ì •ë³´ ì£¼ê¸°ì ìœ¼ë¡œ ì „ì†¡
setInterval(() => {
    for(const id in players){
        const p = players[id];
        p.x += Math.cos(p.angle) * p.speed;
        p.y += Math.sin(p.angle) * p.speed;
        // * [ê¸°ëŠ¥ 2-2] ì´ë™ í›„ bodySegmentsì— ìœ„ì¹˜ ì¶”ê°€ *
        p.bodySegments.push({ x: p.x, y: p.y });
        while (p.bodySegments.length > (p.score + 1)) {
            p.bodySegments.shift();
        }

        // * [ê¸°ëŠ¥ 3] ë¨¹ì´ì™€ ì¶©ëŒ ì‹œ ì œê±°í•˜ê³  ìƒˆ ë¨¹ì´ ìƒì„± *
        // ë¨¹ì´ë¥¼ ë¨¹ìœ¼ë©´ í•´ë‹¹ ë¨¹ì´ë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œìš´ ë¨¹ì´ë¥¼ ëœë¤ ìœ„ì¹˜ì— ìƒì„±í•¨.
        // ì´ ë¡œì§ì€ githubì˜ Cì–¸ì–´ ê¸°ë°˜ ì½˜ì†” ì§€ë ì´ ê²Œì„ì˜ eat_star() í•¨ìˆ˜ì—ì„œ ì°©ì•ˆí•œ ê²ƒìœ¼ë¡œ,
        // í•´ë‹¹ í•¨ìˆ˜ì—ì„œëŠ” rand()ë¥¼ ì´ìš©í•´ ë¨¹ì´ì˜ ìœ„ì¹˜ ì¢Œí‘œë¥¼ ë¬´ì‘ìœ„ë¡œ ìƒì„±í•˜ê³  gotoxyë¥¼ í†µí•´ ì½˜ì†” ìƒì— ì¶œë ¥í•¨.
        // ì´ë¥¼ ë³¸ í”„ë¡œì íŠ¸ì— ë§ì¶° socket ê¸°ë°˜ êµ¬ì¡°ì— ë§ê²Œ ì‘ìš©í•˜ì—¬,
        // JSì˜ Math.random()ì„ í™œìš©í•´ ì„œë²„ì—ì„œ foods ë°°ì—´ì— ìƒˆ ë¨¹ì´ë¥¼ pushí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•¨.
        // ê¸°ì¡´ ì½˜ì†” ê²Œì„ì—ì„œëŠ” í™”ë©´ì— ì§ì ‘ ì¶œë ¥(gotoxy)ì´ì—ˆë‹¤ë©´,
        // ì´ êµ¬ì¡°ì—ì„œëŠ” ì„œë²„ì—ì„œ ê³„ì‚° í›„ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬í•˜ì—¬ canvasì— ì‹œê°í™”(draw)í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ë¨.
        // (github resource: https://github.com/Sehyeon-An/Earthworm_game/blob/master/main3.cpp)
        for (let i = 0; i < foods.length; i++) {    // ëª¨ë“  ë¨¹ì´ ëª©ë¡ì„ ìˆœíšŒí•˜ë©° ì¶©ëŒ ì—¬ë¶€ í™•ì¸
            const food = foods[i]; // í˜„ì¬ ê²€ì‚¬ ì¤‘ì¸ ë¨¹ì´ ê°ì²´ë¥¼ ë³€ìˆ˜ì— ì €ì¥
            if (checkFoodCollision(p, food)) {  // í”Œë ˆì´ì–´ pì™€ í˜„ì¬ ë¨¹ì´ê°€ ì¶©ëŒí–ˆëŠ”ì§€ í™•ì¸
                foods.splice(i, 1); // ì¶©ëŒí•œ ë¨¹ì´ ì‚­ì œ
                foods.push({ // ìƒˆ ë¨¹ì´ ìƒì„±
                    id: `food_${Date.now()}`, // ê³ ìœ  ID ìƒì„±
                    x: Math.random() * 800, // í™”ë©´ ë„ˆë¹„ê°€ 800px
                    y: Math.random() * 600 // ë†’ì´ê°€ 600pxì¼ ë•Œ í•´ë‹¹ ë²”ìœ„ ì•ˆì—ì„œë§Œ ëœë¤í•œ ì¢Œí‘œë¥¼ ìƒì„±í•˜ë„ë¡
                });
                p.score += 1; // ì ìˆ˜ ì¦ê°€ â† [ê¸°ëŠ¥ 4 ì ìˆ˜]
                break; // í•œ ë²ˆì— í•˜ë‚˜ì˜ ë¨¹ì´ë§Œ ë¨¹ë„ë¡ ë£¨í”„ ì¤‘ë‹¨
            }
        }
    }
    // *[ê¸°ëŠ¥ 1] ì¶©ëŒ ì²´í¬ í›„ ì–‘ìª½ í”Œë ˆì´ì–´ ì œê±°*
    // ìˆ˜ë°•ê²Œì„ì²˜ëŸ¼ ìë™ ì¶©ëŒ ì²˜ë¦¬ë¥¼ í™œìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì—,
    // ëª¨ë“  í”Œë ˆì´ì–´ ìŒì„ ìˆœíšŒí•˜ë©° ì¶©ëŒ ì—¬ë¶€ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ê³„ì‚°í•´ ì‚­ì œ ì²˜ë¦¬í•¨
    const ids = Object.keys(players); // í˜„ì¬ ëª¨ë“  í”Œë ˆì´ì–´ id ë°°ì—´
    for (let i = 0; i < ids.length; i++) { // ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ë°˜ë³µë¬¸ ì‹œì‘
        for (let j = i + 1; j < ids.length; j++) { // ë‘ ë²ˆì§¸ í”Œë ˆì´ì–´ ë°˜ë³µë¬¸ (ì¤‘ë³µ ë¹„êµ ë°©ì§€ ìœ„í•´ j = i + 1ë¶€í„° ì‹œì‘)
            const p1 = players[ids[i]]; // ì²« ë²ˆì§¸ í”Œë ˆì´ì–´ ê°ì²´ í• ë‹¹
            const p2 = players[ids[j]]; // ë‘ ë²ˆì§¸ í”Œë ˆì´ì–´ ê°ì²´ í• ë‹¹

            if (checkPlayerCollision(p1, p2)) { // ì¶©ëŒ ì‹œ
                console.log(`ğŸ’¥ ì¶©ëŒ ë°œìƒ: ${p1.id} <-> ${p2.id}`); // ë¡œê·¸ ì¶œë ¥
                delete players[p1.id]; // ì¶©ëŒí•œ í”Œë ˆì´ì–´ ì„œë²„ì—ì„œ ì œê±°
                delete players[p2.id]; // ì„œë²„ ìƒíƒœì—ì„œ ì™„ì „íˆ ì‚­ì œ â†’ ì„œë²„ì—ì„  World.remove ëŒ€ì²´ ë°©ì‹
            }
        }
    }

    io.emit('state',{players, foods}); //stateë¼ëŠ” í—¤ë”ë¥¼ ìƒì„±, [ê¸°ëŠ¥ 3] ì¶”ê°€ë¡œ í´ë¼ì´ì–¸íŠ¸ì— ìµœì‹  ë¨¹ì´ ìƒíƒœ í¬í•¨í•˜ì—¬ ì „ì†¡. [ê¸°ëŠ¥ 4] players ê°ì²´ ì•ˆì— scoreë„ í•¨ê»˜ í¬í•¨ë¨
}, 1000/60); //1ì´ˆì— 60ë²ˆ ì „ì†¡ ì˜ë¯¸

server.listen(PORT,() => {
    console.log("server running at http://localhost:1818");
});